# chapter 17. 리액티브 프로그래밍

오늘날 대규모 애플리케이션은 다음과 같은 3가지를 요구한다.

* 빅데이터: 빅데이터는 페타바이트 단위로 구성되며 매일 증가한다.
* 다양한 환경: 모바일 디바이스에서 수천 개의 멀티 코어 프로세서로 실행되는 클라우드 기반 클러스터에 이르기까지 다양한 환경에 애플리케이션이 배포된다.
* 사용 패턴: 사용자는 1년 내내 항상 서비스를 이용할 수 있으며 밀리 초 단위의 응답 시간을 기대한다.

리액티브 프로그래밍에서는 다양한 시스템과 소스에서 들어오는 데이터 항목 스트림을 비동기적으로 처리하고 합쳐서 이런 문제를 해결한다.
실제로 이런 패러다임에 맞게 설계된 애플리케이션은 발생한 데이터 항목을 바로 처리함으로 사용자에게 높은 응답성을 제공한다.
게다가 한개의 컴포넌트나 애플리케이션 뿐만 아니라 전체의 리액티브 시스템을 구성하는 여러 컴포넌트를 조절하는 데도 리액티브 기법을 사용할 수 있다.

이런 방식으로 구성된 시스템에서는 고장, 정전 같은 상태에 대처할 뿐 아니라 다양한 네트워크 상태에서 메시지를 교환하고 전달할 수 있으며 무거운 작업을 하고 있는 상황에서도 가용성을 제공한다.


<br>

## section 17.1 리액티브 매니페스토

리액티브 애플리케이션과 시스템 개발의 핵심 원칙은 아래와 같다.

* 반응성: 리액티브 시스템은 빠를 뿐 아니라 더 중요한 특징으로 일정하고 예상할 수 있는 반응시간을 제공한다.
* 회복성: 장애가 발생해도 시스템은 반응해야 한다.
* 탄력성: 애플리케이션의 생명주기 동안 다양한 작업 부하를 받게 되는데 이 다양한 작업 부하로 애플리케이션의 반응성이 위협받을 수 있다.
* 메시지 주도: 회복성과 탄력성을 지원하려면 약한 결합, 고립, 위치 투명성 등을 지원할 수 있도록 시스템을 구성하는 컴포넌트의 경계를 명확하게 정의해야 한다.

### 애플리케이션 수준의 리액티브

* 애플리케이션 수준 컴포넌트의 리액티브 프로그래밍의 주요 기능은 비동기로 작업을 수행할 수 있다는 점이다.
* 이번 장 나머지 부분에서는 이벤트 스트림을 블록하지 않고 비동기로 처리하는 것이 최신 멀티코어 CPU의 사용률을 극대화 할 수 있는 방법이다.
* 이 목표를 달성할 수 있도록 리액티브 프레임워크와 라이브러리는 스레드를 퓨처, 액터, 일련의 콜백을 발생시키는 이벤트 루프 등과 공유하고 처리할 이벤트를 변환하고 관리한다.

스레드를 다시 쪼개는 종류의 기술을 이용할 대는 메인 이벤트 루프 안에서는 절대 동작을 블럭하지 않아야 한다는 중요한 전제 조건이 따른다.
데이터베이스나 파일 시스템 접근, 작업 완료까지 얼마나 걸릴지 예측이 힘든 원격 서비스 호출 등 모든 I/O 관련 동작이 블록 동작에 속한다.

두 스레드를 포함하는 풀이 있고 이벤트 스트림 세 개를 처리하는 상황을 가정하자.

* 한 번에 오직 두 개의 스트림을 처리할 수 있는 상황이므로 가능하면 이들 스트림은 두 스레드를 효율적이고 공정하게 공유해야 한다.
* 어떤 스트림의 이벤트를 처리하다보니 파일 시스템 기록 또는 블록되는 API를 이용해 데이터베이스에서 파일을 가져오는 등 느린 I/O 작업이 시작되었다.
* 스레드 1과 스레드 2가 일을 하고 있다면(I/O로 인해 블록되거나) 세 번째 스트림은 처리되지 못한다.

RxJava와 Akka 같은 리액티브 프레임워크도 별도로 지정된 스레드 풀에서 블록 동작을 실행시켜 이 문제를 해결한다.
메인 풀의 모든 스레드는 방해받지 않고 실행되므로 모든 CPU 코어가 가장 최적의 상황에서 동작할 수 있다.
CPU 관련 작업과 I/O 관련 작업을 분리하면 조금 더 정밀하게 풀의 크기 등을 설정할 수 있고 두 종류의 작업의 성능을 관찰할 수 있다.

리액티브 시스템을 만들려면 훌륭하게 설계된 리액티브 애플리케이션 집합이 서로 잘 조화를 이루게 만들어야 한다.

### 시스템 수준의 리액티브

리액티브 시스템은 여러 애플리케이션이 한 개의 일관적인, 회복활 수 있는 플랫폼을 구성할 수 있게 해줄 뿐 아니라 이들 애플리케이션 중 하나가 실패해도 전체 시스템은 계속 운영될 수 있도록 도와주는 소프트웨어 아키텍처다.

<br>

## section 17.2 리액티브 스트림과 플로 API

리액티브 프로그래밍은 리액티브 스트림을 사용하는 프로그래밍이다.

* 리액티브 스트림은 잠재적으로 무한의 비동기 데이터를 순서대로 그리고 블록하지 않는 역압력을 전제해 처리하는 표준 기술이다.
* 역압력은 발행-구독 프로토콜에서 이벤트 스트림의 구독자가 발행자가 이벤트를 제공하는 속도보다 느린 속도로 이벤트를 소비하면서 문제가 발생하지 않도록 보장하는 장치다.
* 이런 상황이 발생했을 때 부하가 발생한 컴포넌트가 완전 불능이 되거나 예기치 않는 방식으로 이벤트를 잃어버리는 등의 문제가 발생하지 않는다.
* 부하가 발생한 컴포넌트는 이벤트 발생 속도를 늦추라고 알리거나, 얼마나 많은 이벤트를 수신할 수 있는지 알리거나, 다른 데이터를 받기 전에 기존의 데이터를 처리하는 데 얼마나 시간이 걸리는지를 업스트림 발행자에게 알릴 수 있어야 한다.

스트림 처리의 비동기적인 특성상 역압력 기능의 내장은 필수라는 사실을 알 수 있다.

* 실제 비동기 작업이 실행되는 동안 시스템에는 암묵적으로 블록 API로 인해 역압력이 제공되는 것이다.
* 안타깝게도 비동기 작업을 실행하는 동안에는 그 작업이 완료될 때까지 다른 유용한 작업을 실행할 수 없으므로 기다리면서 많은 자원을 낭비하게 된다.
* 반면 비동기 API를 이용하면 하드웨어 사용률을 극대화할 수 있지만 다른 느린 다운스트림 컴포넌트에 너무 큰 부하를 줄 가능성도 생긴다.
* 따라서 이런 상황을 방지할 수 있도록 역압력이나 제어 흐름 기법이 필요하다.

다양한 회사들이 참여한 리액티브 스트림 프로젝트에서는 모든 리액티브 스트림 구현이 제공해야 하는 최소 기능 집합을 4 개의 관련 인터페이스로 정의했다.

다양한 라이브러리들이 이 인터페이스를 구현한다.

### Flow 클래스 소개

Flow 클래스는 중첩된 인터페이스 4개를 지원한다.

* Publisher
* Subscriber
* Subscription
* Processor

Publisher가 항목을 발행하면 Subscriber가 한 개씩 또는 한 번에 여러 항목을 소비하는데 Subscription이 이 과정을 관리할 수 있도록 Flow 클래스는 관련된 인터페이스와 정적 메서드를 제공한다.
Publisher는 수많은 일련의 이벤트를 제공할 수 있지만 Subscriber의 요구사항에 따라 역압력 기법에 의해 이벤트 제공 속도가 제한된다.
Publisher는 자바의 함수형 인터페이스로, Subscriber는 Publisher가 발행한 이벤트의 리스너로 자신을 등록할 수 있다.
Subscription은 Publisher와 Subscriber 사이의 제어 흐름, 역압력을 관리한다.

예시 애플리케이션 만들기 시작. 

<br>

## section 17.3 리액티브 라이브러리 RxJava 사용하기

* 좋은 시스템 아키텍처 스타일을 유지하려면 시스템에서 오직 일부에 사용된 개념의 세부 사항을 전체 시스템에서 볼 수 있게 만들지 않아야 한다.
* 따라서 Observable의 추가 구조가 피요한 상황에서만 Observable을 사용하고 그렇지 앟으면 Publisher의 인터페이스를 사용하는 것이 좋다.

역압력은 Pusliher가 너무 빠른 속도로 데이터를 발행하면서 Subscriber가 이를 감당할 수 없는 상황에 이르는 것을 방지하는 기능이다. (io.reactivex.Flowable 클래스)

RxJava는 천 개 이하의 요소를 가진 스트림이나 마우스 움직임, 터치 이벤트 등 역압력을 적용하기 힘든 GUI 이벤트 그리고 자주 발생하지 않는 종류의 이벤트에 역압력을 적용하지 말 것을 권장한다.

물론 Subscriber가 정해진 시간 안에 수신한 모든 이벤트를 처리할 수 있다고 확신할 수 있는 상황이 아니라면 역압력 기능을 끄지 않는 것이 좋다.

### Observable 만들고 사용하기

* RxJava에서는 Observable이 플로 API의 Publisher 역할을 하며 Observer는 Flow의 Subscriber 인터페이스 역할을 한다.
* Observable는 역압력을 지원하지 않으므로 Subscription의 request 메서드를 포함하지 않는다.

<br>

## section 17.4 마치며

* 리액티브 프로그래밍의 기초 사상은 이미 20에서 30년 전에 수립되었지만 데이터 처리량과 사용자 기대치 덕분에 최근에서야 인기를 얻고 있다.
* 리액티브 소프트웨어가 지녀야 할 네 가지 관련 특성을 서술하는 리액티브 매니페스토가 리액티브 프로그래밍 사상을 공식화한다.
* 여러 애플리케이션을 통합하는 리액티브 시스템과 한 개의 애플리케이션을 구현할 때에 각각 다른 접근 방식으로 리액티브 프로그래밍 원칙을 적용할 수 있다.
* 리액티브 애플리케이션은 리액티브 스트림이 전달하는 한 개 이상의 이벤트를 비동기로 처리함을 기본으로 전제한다.
* 리액티브 애플리케이션 개발에서 리액티브 스트림의 역할이 핵심적이므로 넷플릭스, 피보탈, 라이트밴드, 레드햇 등은 다양한 구현의 상호 운용성을 극대화할 수 있도록 컨소시엄을 구성해 개념을 표준화한다.
* 리액티브 스트림은 비동기적으로 처리되므로 역압력 기법이 기본적으로 탑재되어 있다. 역압력은 발행자가 구독자보다 빠른 속도로 아이템을 발행하므로 발생하는 문제를 방지한다.
* 설계의 표준화 절차 결과가 자바에 반영 되었다. 자바 9 플로 API는 Publisher, Subscriber, Subscription, Processor 네 개의 핵심 인터페이스를 정의한다.
* 대부분의 상황에서는 이들 인터페이스를 직접 구현할 필요가 없으며 실제 이들 인터페이스는 리액티브 패러다임을 구현하는 다양한 라이브러리의 공용어 역할을 한다.
* 가장 흔한 리액티브 프로그래밍 도구로 RxJava를 꼽을 수 있으며 이 라이브러리는 자바 9 플로 API의 기능에 대해 더해 다양한 강력한 연산자를 제공한다.
* 예를 들어 한 스트림에서 방출한 요소를 변환하거나, 거를 수 있으며 여러 스트림의 데이터를 일부 합치거나 전체를 모을 수 있다.
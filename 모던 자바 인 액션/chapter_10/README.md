# chapter 10. 람다를 이용한 도메인 전용 언어

## section 10.1 도메인 전용 언어

* DSL은 특정 비즈니스 도메인의 문제를 해결하려고 만든 언어다.
* 자바에서는 도메인을 표현할 수 있는 클래스와 메서드 집합이 필요하다.
* DSL이란 특정 비즈니스 도메인을 인터페이스로 만든 API라고 생각할수 있다.
* DSL은 범용 프로그래밍 언어가 아니다.
* DSL에서 동작과 용어는 특정 도메인에 국한되므로 다른 문제는 걱정할 필요가 없고 오직 자신의 앞에 놓인 문제를 어떻게 해결할지에만 집중할 수 있다.
* DSL을 이용하면 사용자가 특정 도메인의 복잡성을 더 잘 다룰 수 있다.
* 저수준 구현 세부 사항 메서드는 클래스의 비공개로 만들어서 저수준 구현 세부 내용은 숨길 수 있다.
* 다음 두 가지 필요성을 생각하면서 DSL을 개발해야 한다.
  * 의사 소통의 왕: 우리 코드의 의도가 명확히 전달되어야 하며 프로그래머가 아닌 사람도 이해할 수 있어야 한다. 이런 방식으로 코드가 비즈니스 요구사항에 부합하는지 확인할 수 있다.
  * 한번 모드를 구현하지만 여러 번 읽는다: 가독성은 유지보수의 핵심이다. 즉 항상 우리의 동료가 쉽게 이해할 수 있도록 코드를 구현해야 한다.

### 10.1.1 DSL의 장점과 단점

* DSL은 만병통치약이 아니다.
* DSL의 장점은 다음과 같다. 간결함, 가독성, 유지보수, 높은 수준의 추상화, 집중, 관심사 분리
* 단점은 다음과 같다. DSL 설계의 어려움, 개발 비용, 추가 우회 계층, 새로 배워야 하는 언어, 호스팅 언어의 한계

### 10.1.2 JVM에서 이용할 수 있는 다른 DSL 해결책

* DSL의 카테고리를 구분하는 방법은 내부 DSL과 외부 DSL로 나누는 것이다.
* 내부 DSL은 순수 자바 코드 같은 호스팅 언어를 기반으로 구현하는 반면, 외부 DSL은 호스팅 언어와는 독립적으로 자체의 문법을 가진다.
* 스칼라나 그루비처럼 자바가 아니지만 JVM에서 실행되며 더 유연하고 표현력이 강력한 언어도 생겼다. 이들을 다중 DSL이라는 세 번째 카테고리로 정한다.

#### 내부 DSL

* 내부 DSL이란 쉽게 말하면 자바로 구현한 DSL이다.
* 람다를 적극적으로 활용하면 익명 내부 클래스를 사용해 DSL을 구현하는 것보다 장황함을 크게 줄여 신호 대비 잡음 비율을 적정 수준으로 유지하는 DSL을 만들 수 있다.
* 사용자가 기술적인 부분을 염두에 두고 있다면 자바를 이용한 DSL을 만들 수 있다.
* 자바 문법이 큰 문제가 아니라면 순수 자바로 DSL을 구현함으로 다음과 같은 장점을 얻을 수 있다.
    * 기존 자바 언어를 이용하면 외부 DSL에 비해 새로운 패턴과 기술을 배워 DSL을 구현하는 노력이 현저하게 줄어든다.
    * 순수 자바로 DSL을 구현하면 나버지 코드와 함께 DSL을 컴파일 할 수 있다. 따라서 다른 언어의 컴파일러를 이용하거나 외부 DSL을 만드는 도구를 사용할 필요가 없으므로 추가 비용이 들지 않는다.
    * 개발팀이 새롱누 언어를 배우거나 또는 익숙하지 않은 복잡한 외부 도구를 배울 필요가 없다.
    * DSL 사용자는 기존의 자바 IDE를 이용해 자동 완성, 자동 리팩터링 같은 기능을 그대로 즐길 수 있다. 최신 IDE는 다른 유명한 JVM 언어도 지원하지만 자바 만큼의 기능을 지원하진 못한다.
    * 한 개의 언어로 한 개의 도메인 또는 여러 도메인을 대응하지 못해 추가로 DSL을 개발해야 하는 상황에서 자바를 이용한다면 DSL을 쉽게 합칠 수 있다.
* 같은 자바 바이트 코드를 사용해 JVM 기반 프로그래밍 언어를 이용함으로 DSL 합침 문제를 해결하는 방법도 있다.
* 이런 언어를 다중 DSL이라고 부른다.

#### 다중 DSL

* JVM에서 실행될 수 있는 언어가 정말 많다. 이들은 모두 자바보다 젊으며 제약을 줄이고, 간편한 문법을 지향하도록 설계 되었다.
* DSL은 기반 프로그래밍 언어의 영향을 받으므로 간결한 DSL을 만드는 데 새로운 언어의 특성들이 아주 중요하다.
* 스칼라 예제를 살펴보았다. 
* 다중 DSL에서는 다음과 같은 불편함이 발생할 수 있다.
* 새로운 프로그래밍 언어를 배우거나 또는 팀의 누군가가 이미 해당 기술을 가지고 있어야 한다. 멋진 DSL을 만드려면 이미 기존 언어의 고급 기능을 사용할 수 있는 충분한 지식이 필요하기 때문이다.
* 두 개 이상의 언어가 혼재하므로 여러 컴파일러로 소스를 빌드하도록 빌드 과정을 개선해야 한다.
* JVM에서 실행되는 거의 모든 언어가 자바와 백 퍼센트 호환을 주장하고 있지만 자바와 호환성이 완벽하지 않을 때가 있다.

#### 외부 DSL

* 프로젝트에 DSL을 추가하는 세 번째 옵션은 외부 DSL을 추가하는 것이다.
* 그러려면 자신만의 문법과 구문으로 새 언어를 설계해야 한다.
* 새 언어를 파싱하고, 파서의 결과를 분석하고, 외부 DSL을 실행할 코드를 만들어야 한다.
* 외부 DSL의 제일 큰 장점은 외부 DSL이 제공하는 무한한 유연성이다.
* 우리에게 필요한 특성을 완벽하게 제공하는 언어를 설게할 수 있다는 것이 장점이다.
* 자바로 개발된 인프라 구조 코드와 외부 DSL로 표현한 비즈니스 코드를 명확하게 분리한다는 것도 장점이다.
* 그러나 DSL과 호스트 언어 사이에 인공 계층이 생기므로 이는 양날의 검이다.

## section 10.2 최신 자바 API의 작은 DSL

* Comparator 인터페이스 예시를 통해 람다가 어떻게 네이티브 자바 API의 재사용성과 메서드 결합도를 높였는지 살펴봄.
* 익명 클래스를 구현 -> 람다식 -> 메서드 참조 순으로 코드를 개선.

### 10.2.1 스트림 API는 컬렉션을 조작하는 DSL

* Stream 인터페에스는 네이티브 자바 API에 작은 내부 DSL을 적용하는 좋은 예다.
* Stream은 컬렉션 항목을 필터, 정렬, 변환, 그룹화, 조작하는 작지만 강력한 DSL로 볼 수 있다.
* 파일을 파싱하는 예제를 살펴봄. 단순 반복문을 스트림을 사용해서 깔끔한 코드로 리팩터링함.

### 10.2.2 데이터를 수집하는 DSL인 Collectors

* Strem 인터페이스를 데이터 리스트를 조작하는 DSL로 간주할 수 있다.
* 마찬가지로 Collector 인터페이스는 데이터를 수집하는 DSL로 간주할 수 있다.
* 자동차 객체를 브랜드별, 색상별로 그룹화하는 예제를 살펴보았다.

## section 10.3 자바로 DSL을 만드는 패턴과 기법

* DSL은 특정 도메인 모델에 적용할 친화적이고 가독성 높은 API를 제공한다.
* 간단한 도메인 모델을 정의하고 사용할 DSL을 만드는 패턴을 살펴본다.

### 10.3.1 메서드 체인 

* 메서드 체인을 사용해 빌더 패턴 구현.
* 사용된 절차를 강요하며 안정성을 높이고, 정적 메서드 사용을 최소화하고, 메서드 이름이 인수의 이름을 대신하도록 만듦으로 가독성 개선
* 빌더를 모두 구현해야한다는 것이 메서드 패턴의 단점. 상위 수준의 빌더와 하위 수준의 빌더를 연결하는 많은 접착 코드가 필요하다.

### 10.3.2 중첩된 함수 이용 

* 중첩된 함수 DSL 패턴은 다른 함수 안에 함수를 이용해 도메인 모델을 만든다.
* 메서드 체인 방식에 비해 함수의 중척 방식이 도메인 객체 계층 구조에 그대로 반영된다는 것이 장점이다.
* 안타깝게도 이 방식에는 문제가 있는데, 결과 DSL에 더 많은 괄호를 사용해야 한다는 사실을 눈치챘을 것이다.
* 더욱이 인수 목록을 정적 메서드에 넘겨줘야 한다는 제약이 있다.
* 도메인 객체에 선택 사항 필드가 있으면 인수를 생략할 수 있으므로 이 가능성을 처리할 수 있도록 여러 메서드 오버라이드를 구현해야 한다.
* 마지막으로 인수의 의미가 이름이 아니라 위치에 의해 정의 되었다.

### 10.3.3 람다 표현식을 이용한 함수 시퀀싱

* DSL 패턴은 람다 표현식으로 정의한 함수 시퀀스를 사용한다.
* 이런 DSL을 만드려면 람다 표현식을 받아 실행해 도메인 모델을 만들어 내는 여러 빌더를 구현해야 한다.
* DSL 구현해서 했던 방식과 마찬가지로 이들 빌더는 메서드 체인 패턴을 이용해 만들려는 객체의 중간 상태를 유지한다.
* 메서드 체인 패턴에는 주문을 만드는 최상위 수준의 빌더를 가졌지만 이번에는 Consumer 객체를 빌더가 인수로 받음으로 DSL 사용자가 람다 표현식으로 인수를 구현할 수 있게 했다.
* 이 패턴은 이전 두 가지 DSL 형식의 두 가지 장점을 더한다.
* 메서드 체인 패턴처럼 플루언트 방식으로 거대 주문을 정의할 수 있다.
* 또한 중첩 함수 형식처럼 다양한 람다 표현식의 중첩 수준과 비슷하게 도메인 객체의 계층 구조를 유지한다.
* 많은 설정 코드가 필요하며 DSL 자체가 자바 8 람다 표현식 문법에 의한 잡음의 영향을 받는다는 것이 이 패턴의 단점이다.

### 10.3.4 조합하기

* 살펴본 3가지 DSL은 각자 장단점을 가지고 있다.
* 한 DSL에 한 개의 패턴만 사용하라는 법은 없다.
* 중첩된 함수 패턴과 람다 기법을 혼용한 예제를 살펴봄.
* 해당 DSL은 사용자가 해당 DSL 방식을 익히는데 오래 걸린다는 단점이 있다.

### 10.3.5 DSL에 메서드 참조 사용하기

* 메서드 참조를 사용하는 예제를 확인함.

## section 10.4 실생활의 자바 DSL

* jOOQ, 큐컴버, 스프링 통합 등 자바 프레임워크의 DSL을 확인함.

## section 10.5 정리

* DSL의 주요 기능은 개발자와 도메인 전문가 사이의 간격을 좁히는 것이다. 애플리케이션의 비즈니스 로직을 구현하는 코드를 만든 사람이 프로그램이 사용될 비즈니스 필드의 전문 지식을 갖추긴 어렵다. 개발자가 아닌 사람도 이해할 수 있는 언어로 이런 비즈니스 로직을 구현하 수 있다고 해서 도메인 전문가가 프로그래머가 될 수 있는 것은 아니지만 적어도 로직을 읽고 검증하는 역할은 할 수 있다.
* DSL은 크게 내부적 DSL과 외부적 DSL이 있다. 내부적 DSL은 개발 노력이 적게 드는 반면 호스팅 언어의 문법 제약으 받는다. 외부적 DSL은 높은 유연성을 제공하지만 구현하기가 어렵다.
* JVM에서 이용할 수 있는 다양한 언어로 다중 DSL을 개발할 수 있다. 그러나 자바와 호환성 문제가 있을 수 있다.
* 자바의 장황함과 문법적 엄격함 때문에 보통 자바는 내부적 DSL을 개발하는 언어로는 적합하지 않다. 그러나 람다 표현식과 메서드 참조 덕분에 상황이 개선되었다.
* 최신 자바는 자체 API에 작은 DSL을 제공한다. Stream, Collectors 클래스등에서 제공하는 작은 DSL은 특히 컬렉션 데이터의 정렬, 필터링, 변환, 그룹화에 유용하다.
* 자바로 DSL을 구현할 때 보통 메서드 체인, 중첩 함수, 함수 시퀀싱 3 가지 패턴이 사용된다. 
* 각각의 패턴은 장단점이 있지만 모든 기법을 한 개의 DSL에 합쳐 장점만을 누릴 수 있다.


### 10장은 반드시 복습을 하면 좋겠다. 특히 10.3 파트
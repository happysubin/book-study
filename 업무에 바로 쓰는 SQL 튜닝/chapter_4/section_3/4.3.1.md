
# 작은 테이블이 먼저 조인에 참여하는 나쁜 SQL 문

## 튜닝 전

```sql
SELECT 매핑.사원번호, 부서.부서번호
FROM 부서사원 매핑, 부서
WHERE 매핑.부서번호 = 부서.부서번호
  AND 매핑.시작일자 >= '2002-03-01';
```

```sql
explain SELECT 매핑.사원번호, 부서.부서번호
        FROM 부서사원 매핑, 부서
        WHERE 매핑.부서번호 = 부서.부서번호
          AND 매핑.시작일자 >= '2002-03-01';
```

* 드라이빙 테이블인 부서 테이블과 드리븐 테이블인 부서사원 테이블은 중첩 루프 조인을 수행한다.
* 작은 크기의 부서 테이블에서 부서.부서번호 열만 SELECT 절과 WHERE 절에 필요하므로, I_인덱스를 활용해 인덱스 풀 스캔을 한다.
* 상대적으로 큰 크기의 부서사원 테이블은 I_부서번호 인덱스로 인덱스 스캔을 수행한다.
* 이때 rows 항목의 43192라는 수치는 SQL문을 수행하고자 조사한 행의 예측 건수로, 인덱스 스캔을 하고 랜덤 액세스로 테이블에 접근하게 된다.
* 드리븐 테이블에서 대량의 데이터에 대해 랜덤 액세스하면 비효율적이다.

> 드라이빙 테이블 == 아우터 테이블 == NL 조인할 때 먼저 읽는 테이블

> 드리븐 테이블 == 이너 테이블 

* 위 작성된 SQL 문에서 상대적으로 규모가 큰 부서사원 테이블의 매핑.시작일자 >= '2002-03-1' 조건절을 먼저 적용할 수 있다면 조인할 때 비교대상이 줄어들 것이다.

## 튜닝 후

```sql
SELECT STRAIGHT_JOIN 매핑.사원번호, 부서.부서번호
FROM 부서사원 매핑, 부서
WHERE 매핑.부서번호 = 부서.부서번호
  AND 매핑.시작일자 >= '2002-03-01';
```

```sql
explain SELECT STRAIGHT_JOIN 매핑.사원번호, 부서.부서번호
        FROM 부서사원 매핑, 부서
        WHERE 매핑.부서번호 = 부서.부서번호
          AND 매핑.시작일자 >= '2002-03-01';
```

* STRAIGHT_JOIN 힌트를 사용해 FROM 절에 작성된 테이블 순서대로 조인에 참여할 수 있도록 고정해야 한다.
* 즉 부서사원 테이블에 먼저 접근하고, 이후 부서 테이블에 반복하여 접근하면서 최종 결과를 추출한다.

<br>

* 먼저 접근하는 드라이빙 테이블은 부서사원 테이블로 테이블의 랜덤 액세스 없이 테이블 풀 스캔으로 한 번에 다수의 페이지에 접근한다.
* 그리고 드라이빙 테이블에서 추출된 데이터마늠 반복하여 접근하게 되는 드리븐 테이블은 부서 테이블이 된다.
* 즉, 상대적으로 대용량인 부서사원 테이블을 테이블 풀 스캔으로 처리하고, 부서 테이블에는 기본 키로 반복 접근하여 1개의 데이터에만 접근하는 식으로 수행된다.




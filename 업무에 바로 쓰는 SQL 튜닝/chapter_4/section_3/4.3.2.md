
# 메인 테이블에 계속 의존하는 나쁜 SQL 문

## 튜닝 전

```sql
SELECT 사원.사원번호, 사원.이름, 사원.성
FROM 사원
WHERE 사원번호 > 450000
  AND (SELECT MAX(연봉)
       FROM 급여
       WHERE 사원번호 = 사원.사원번호
      ) > 100000
```

```sql
explain SELECT 사원.사원번호, 사원.이름, 사원.성
        FROM 사원
        WHERE 사원번호 > 450000
          AND (SELECT MAX(연봉)
               FROM 급여
               WHERE 사원번호 = 사원.사원번호
              ) > 100000
```

* 실행 계획의 type 항목에 DEPENDENT SUBQUERY라고 나온다.
* 보통 DEPENDENT라는 키워드가 있으면, 외부 테이블에서 조건절을 받은 뒤 처리되어야 하므로 튜닝 대상으로 고려할 수 있다.
* 따라서 WHERE 절의 서브 쿼리에서 외부 테이블인 사원 테이블의 사원 정보를 조건절 (WHERE 사원번호 = 사원.사원번호)로 받아야 할지 고민해봐야 한다.
* 서브 쿼리를 최대한 조인으로 풀라는 얘기 같다.

## 튜닝 후

```sql
SELECT 사원.사원번호, 사원.이름, 사원.성
FROM 사원, 급여
WHERE 사원번호 > 450000
  AND 사원.사원번호 = 급여.사원번호
GROUP BY 사원.사원번호
HAVING MAX(급여. 연봉) > 100000;
```

```sql
explain SELECT 사원.사원번호, 사원.이름, 사원.성
        FROM 사원, 급여
        WHERE 사원.사원번호 > 450000
          AND 사원.사원번호 = 급여.사원번호
        GROUP BY 사원.사원번호
        HAVING MAX(급여. 연봉) > 100000;
```

* 먼저 드라이빙 테이블은 급여 테이블이고, 그 다음으로 접근하는 드리븐 테이블은 사원 테이블이다.
* 또한 급여 테이블에 먼저 접근하기 위한 범위 축소 조건 where 절을 급여.사원번호 > 450000 조건절로 변형되어 적용된다.

* 튜닝 전의 실행계획에서 수행된 급여 테이블의 DEPENDENT SUBQUERY 방식은 제거되었고
* 사원 테이블과 급여 테이블이 단순히 조인하는 방식으로 변경되어 수행 효율이 향상됨을 확인할 수 있다.
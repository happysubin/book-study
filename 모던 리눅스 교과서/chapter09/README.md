# chapter 09. 심화 주제

## 프로세스 간 통신

리눅스에는 파이프부터 소켓, 공유, 메모리에 이르기까지, 사용 가능한 프로세스 간 통신(IPC) 옵션이 매우 많다.
IPC는 프로세스가 통신하고, 활동을 동기화하고, 데이터를 공유할 수 있게 해준다.
예를 들어 도커 데몬은 컨테이너 관리에 맞춰 구성할 수 있는 소켓을 사용한다.

### 시그널

시그널은 원래 커널이 특정 이벤트를 사용자 공간 프로세스에 알리기 위한 방법으로 개발됐다.
즉 프로세스에 전송되는 비동기 알림이라고 생각하면 된다.
사용할 수 있는 시그널은 다양하며, 대부분은 프로세스 중지나 종료와 같은 기본 동작이 함께 제공된다.

대부분의 시그널에 대해 리눅스가 제공하는 기본 동작을 계속 수행하게 두는 대신 커스텀 핸들러를 정의한다.
이런 방법은 일례로 정리 작업을 하거나 단순히 특정 시그널을 무시하고자 할 때 유용하다.

프로세스가 서로 통신할 때 사용할 용도로 의미가 정의되지 않은 시그널도 있으며, 양쪽 당사자가 이 시그널의 의미에 동의하는 경우 비동기 알림을 보낼 수 있다.

프로세스에 시그널을 보내는 일반적인 방법 중 하나가 kill 명령이다.
trap 명령으로도 시그널 처리가 가능하다.

시그널은 간단하지만 강력한 IPC 메커니즘이다.

### 이름있는 파이프

우리는 한 프로세스 stdout을 다른 프로세스의 stin과 연결해 데이터를 전달하는데 사용할 수 있픞 파이프(|)에 대해 배웠다.
이런 파이프를 일컬어 __이름 없는 파이프__ 라고 한다.
이 아이디어를 한 단계 더 발전시켜 원하는 이름을 지정할 수 있게 한 파이프가 이름 있는 파이프다.

이름 없는 파이프와 마찬 가지로 이름 있는 파이프는 일반 파일 I/O와 함께 동작할 수 있으며 선입선출 발싱글 사용한다.
이름 없는 파이프와 달리 이름 있는 파이프의 수명은 함께 사용하는 프로세스로 제한되지 않는다.
엄밀히 말하면, 일므 있는 파이프는 pipefs 의사 파일시스템을 사용하는 파이프의 레퍼다.

### 유닉스 도메인 소켓

단일 시스템에 대해 독점적으로 작동하는 다른 종류의 소켓도 있으며 이런 소켓 중 하나가 바로 유닉스 도메인 소켓이다.
유닉스 도메인 소켓은 양방향 다자간 통신 엔드포인트다.
이는 여러 컨슈머를 가질 수 있음을 의미한다.

도메인 소켓은 스트림 지향, 데이터그램 지향, 시퀀스 패킷 등 세 가지 종류로 제공된다.
주소를 찾는 작업은 파일 시스템 경로 이름을 기반으로 동작한다.
굳이 IP주소와 포트를 사용하지 않고 간단한 파일 경로를 써도 충분하다.

일반적으로는  프로그래밍 방식으로 도메인 소켓을 사용한다.
하지만 시스템 문제를 해결할 때, 예를 들어 소켓과 수동으로 상호 작용하기 위해 커맨드라인에서 socat도구를 사용해야 하는 상황이 생길 수 있다.

## 가상 머신

가상화 아키텍쳐는 다음과 같은 구성으로 이루어진다.

* CPU: 하드웨어 가상화를 지원
* 커널 기반의 가상 머신: 리눅스 커널에서 찾을 수 있다.
* 사용자 공간 구성요소
  * 가상 머신 모니터: 가상 머신을 관리하며 QEMU와 파이어크래커 같은 가상 디바이스를 에뮬레이트. 또한 프로그래밍 방식으로 사용할 수 있으며 가상 머신 모니터 표준화를 목표로 하는 일반 API를 제공하는 라이브러리인 libvirt도 있다.
  * 게스트 커널
  * 게스트 프로세스

호스트 커널에서 네이티브로 실행되는 프로세스는 게스트 프로세스와 격리된다.
즉 일반적으로 호스트의 물리적 CPU와 메모리는 게스트 활동의 영향을 받지 않는다.

예를 들어 VM에서 공격이 진행되었다 해도, 호스트 커널과 프로세스는 영향을 받지 않는다.
하지만 실제로 로우해머, 멜트다운, 스펙터처럼 예외가 있을 수 있다.

### 커널 기반 가상머신

커널 기반 가상 머신(KVM)은 AMD-V나 인텔 등과 같이 가상화 확장을 지원하는 x86 하드웨어용 리눅스 네이티브 가상화 솔루션이다.

KVM 커널 모듈은 코어 모듈과 CPU 아키텍처별 모듈이라는 두 부분으로 나뉘어 있다.
KVM에서 리눅스 커널은 하이퍼바이저 역할을 하며 어려운 작업 대부분을 처리한다.
또한 I/O 가상화를 허용하는 버티오 와 같은 통합 드라이버도 있다.
최근의 하드웨어는 일반적으로 가상화를 지원하므로 KVM은 당연히 사용 가능하지만 
우리 시스템이 KVM을 사용하는 지 확인하려면 다음 명령어를 사용하자.

```shell
grep 'svm\|vmx' /proc/cpuinfo
lsmod | grep kvm
```


### 파이어 크래커

파이어크래커는 KVM 인스턴스를 관리할 수 있는 가상 머신 모니터다.
러스트 언어로 작성됐으며 주로 AWS 람다와 AWS 파게이트 같은 서버리스 제품을 위해 AWS에서 개발했다.

파이어크래커는 동일한 물리적 시스템에서 멀티 테넌드 워크로드를 안전하게 실행하도록 설계 됐다.
파이어크래커 VMM은 호스트에 HTTP API를 노출하는 마이크로 가상 머신이란 것을 관리해 사용자가 이 microVM을 시작, 쿼리, 중지할 수 있게 해준다.
호스트에서 TUN/TAP 디바이스를 사용해 네트워크 인터페이스를 에뮬레이트하고 블록 디바이스는 버티오 디바이스를 지원하는 호스트의 파일에 의해 지원된다.

## 모던 리눅스 배포판

* 레드햇 엔터프라이즈 리눅스 코어 OS
* 플랫카 컨테이너 리눅스
* 보틀로켓
* 랜처 OS

## 특별한 보안도구

* 커버로스
* 장착현 인증 모듈

# chapter 07. 네트워킹

현대 환경에서는 리눅스가 제공하는 네트워크 스택이 필수 구성요소로, 이게 없다면 할 수 있는 일이 별로 없다.

## 기본 개요

모던 환경에서 네트워킹은 중심적 역할을 수행한다. 여기에는 앱 설치, 웹 검색, 메일이나 소셜 미디어 사용 같은 작업부터 원격 시스템 작업도 포함된다.
네트워크에는 변화하는 분야와 계층이 많기 때문에, 문제가 발생하면 하드웨어 때문인지 아니면 소프트웨어 스택에서 비롯된 문제인지 파악하기 어려울 수 있다.

리눅스 네트워킹이 다루는 또 다른 문제는 추상화에서 비롯된다.
이 장에서 다루는 많은 도구들은 높은 수준의 사용자 인터페이스를 제공하기 때문에 실제로 원격 시스템에서 실행되는 파일이나 애플리케이션이 로컬 머신에서 접근하거나 조작할 수 있는 것처럼 보인다.
원격 리소스가 마치 로컬에 있는 것처럼 보이게 하는 추상화는 유용한 기능이지만 결국 이 모든 것의 근간은 유선과 무선을 통해 이동하는 bit 라는 사실을 잊어서는 안된다.
문제를 해결하거나 테스트할 때는 이점을 염두에 두어야 한다.

## TCP/IP 스택

TCP/IP 스택은 대부분 IETF 사양에 의해 정의된 여러 프로토콜과 도구로 이루어진 계층 네트워크 모델이다.
각 계층은 자신의 바로 위와 아래에 있는 계층만 인식하고 통신할 수 있어야 한다.
데이터는 패킷으로 캡슐화되며 각 계층은 일반적으로 해당 기능과 관련된 정보를 포함한 헤더로 데이터를 래핑한다.
따라서 데이터를 보내려는 앱은 최상위 계층과만 직접 상호작용하고, 최상위 계층데이터에서 헤더를 추가해 다시 아래 스택으로 내려보내는 식이 된다.
반대로 앱이 데이;터를 수신할 때는 이 데이터가 먼저 최하위 계층에 도착하고 각 계층이 차례대로 찾은 헤더 정보를 기반으로 해서 페이로드를 상위계층에 전달한다.

__링크 계층__

* 스택의 가장 하부 계층으로서 하드웨어와 커널 드라이브를 다루며 물리적 디바이스 간에 패킷이 어떻게 전송되는지에 중점을 둔다.

__인터넷 계층__

* 인터넷 프로토콜을(IP)을 이용하며, 라우팅에 초점을 맞춘 계층이다.
* 즉 네트워크를 통한 기기간의 패킷 전송을 지원한다.

__전송 계층__

* 세션 기반의 안정적인 통신을 위한 TCP와 비 연결형 통시늘 위한 UDP를 사용해 (가상 또는 물리적) 호스트 사이의 종단 간 통신을 제어하는 계층이다.
* 주로 패킷이 전송되는 방식을 다루며 여기에는 포트를 통한 시스템의 개별 서비스 지정과 데이터 무결성이 포함된다.
* 또한 리눅스는 소켓을 통신의 엔드포인트로 지원한다.

__애플리케이션 계층__

* 웹, SSH, 메일과 같은 사용자 대면 도구와 앱을 다루는 계층이다.

계층화란 계층의 헤더와 페이로드가 다음 계층의 페이로드를 구성하는 것을 의미한다.

### 링크 계층

TCP/IP 스택의 링크 계층은 바이트, 유선, 전자기파, 디바이스 드라이버, 네트워크 인터페이스 같은 하드웨어, 혹은 하드웨어에 가까운 항목에 관한것이다.
아래와 같은 용어를 자주 볼 것이다.

* 이더넷
  * 유선을 사용해 기기를 연결하는 네트워킹 기술로 근거리 통신망 LAN에 자주 사용된다.
* 무선
  * 와이파이라고도 알려진 통신 프로토콜 및 방법의 한 종류로 유선을 사용하지 않고 전자기파를 사용해 데이터를 전송한다.
* MAC 주소
  * MAC는 media access control은 각 하드웨어마다 고유한 48비트 식별자로서, 각 기기(NIC)를 식별하는 데 사용된다.
  * MAC 주소는 일반적으로 첫 24비트를 조직 고유 식별자로 사용해 제조업체 정보를 인코딩한다.
* 인터페이스
  * 네트워크 연결, 이는 물리적 인터페이스일 수도 루프백 인터페이스 lo 같은 가상 인터페이스일 수도 있다.

__네트워크 인터페이스 컨트롤러__

하드웨어 장비의 필수 요소 중 하나는 네트워크 인터페이스 컨트롤러로 네트워크 인터페이스 카드라고도 부른다. (NIC)
NIC는 유선 표준이나 IEEE 802.11의 많은 무선 표준 중 하나를 통해 네트워크에 물리적 연결을 제공한다.
네트워크의 일부가 된 NIC는 전송하려는 바이트의 디지털 표현을 전기 혹은 전자기 신호로 바꾼다.
수신 경로의 경우 그 반대다. 즉 NIC는 수신하는 모든 물리적 신호를 소프트웨어가 처리할 수 있는 비트와 바이트로 변환한다.

아래 명령을 통해 NIC에 대한 정보를 살펴볼 수 있다.

```shell
ifconfig
ip link show
```

### 주소 결정 프로토콜(ARP)

ARP는 MAC 주소를 IP 주소에 매핑한다.
어떤 의미에서는 링크 계{층을 그 위의 계층인 인터넷 계층과 연결하는 것이다.

실제로 동작하는 모습을 살펴보자

```shell
arp
ip neigh
```

무선 디바이스를 표시하거나 구성하거나 문제를 해결하려 할 때도 iw 명령을 사용하면 된다.

```shell
iw dev wlp1s0(무선 nic) info
```

추가 적으로 다음과 같이 라우터와 트래픽 관련 정보를 수집할 수 있다.

```shell
iw dev wlp1s0(nic) link
```

### 인터넷 계층

인터넷 계층은 네트워크의 한 시스템에서 다른 시스템으로 패킷을 라우팅하는 것과 관련이 있다.
인터넷 계층의 설계는 사용 가능한 네트워크 인프라가 신뢰할 수 없으며 참여자가 자주 변겨오딘다고 가정한다.

인터넷 계층은 최선의 전달을 제공하고 모든 패킷을 독립적으로 취급한다.
그 결과 상위 계층은 패킷의 순서, 재시도, 배달 포장을 포함한 신뢰성 문제를 처리한다.

이 계층에서 기기를 논리적으로 고유하게 식별하기 위해 전 세계적으로 압도적으로 많이 사용되고 있는 프로토콜이 바로 인터넷 프로토콜이며 IP는 IP 버전 4와 IP 버전 6의 두 가지 형태로 제공된다.

IP 주소 범위는 네트워크에 할당되며 해당 네트워크 내에서 개별 호스트에 할당된다.
오늘날은 __CIDR__ 이 IP 할당과 관련된 유일한 방법이다.
CIDR 형식은 두 부붕느로 구성된다.

* 첫 번째 부분은 네트워크 주소를 나타낸다. 10.0.0.0
* 두번째 부분은 얼마나 많은 비트가 주소 범위에 속하는지를 정의한다. /24
* 10.0.0.0/24

다음과 같이 예약된 IPv4 주소도 중요하며 알아둬야 한다.

* 127.0.0.1: 이 서브넷은 로컬 주소용으로 예약되어 있으며 가장 중요한 것은 루프백 주소인 127.0.0.1 이다.
* 169.254.0.0/16
  * 이들은 링크 로컬 주소로 전송된 패킷이 네트워크의 다른 부분으로 전달되지 않아야 함을 의미한다.
  * 아마존 웹 서비스 같은 일부 클라우드 공급자는 이 주소를 특수 서비스(메타데이터)에 사용한다.
* 224.0.0.0/24
  * 이 범위는 멀티캐스트용으로 예약되어 있다.

RFC 1918에는 사설 IP 범위가 정의돼 있다.
사설 IP 범위는 해당 IP 주소를 공용 인터넷에서 라우팅할 수 없음을 의미한다.
따라서 내부적으로 지정하는 편이 더 안전하다.

* 10.0.0.0에서 10.255.255.255 까지
* 172.16.0.0에서 172.31.255.255까지
* 192.168.0.0에서 192.168.255.255까지

서버 관점에서 0.0.0.0이 시스템에 있는 모든 IPv4 주소를 의미한다.
이는 알려진 모든 IP로 바뀔 때 까지 송신지 선택을 위해 '모든 사용 가능한 IP 주소에서 수신 대기하라'라는 의미다.

아래는 IP 관련 항목에 대해 시스템을 쿼리하는 방법이다.

```shell
ip addr show
```

### IPv6

IPv6는 TCP/IP 통신에서 엔드포인트 식별용으로 쓰이는 128 비트 숫자다.
즉 개별 기기를 10^38개까지 할당할 수 있음을 의마한다.
IPv4와 달리 IPv6는 각각 16비트로 구성된 8개 그룹을 콜론으로 구분하는 16진수 표현식을 사용한다.

IPv4와 IPv6는 호환되지 않는다.

IPv6도 예약 주소가 ㅇ존재한다.


### 인터넷 제어 메시지 프로토콜 (ICMP)

RFC 792에는 에러 메시지의 가용성 같은 운영 정보를 보내는 저수준 구성요소에 사용되는 ICMP가 정의돼 있다.

gping을 사용해 기존 ping 명령어를 대신할 수 있다.

### 라우팅

리눅스에서 네트워크 스택의 일부는  라우팅과 관련이 있다.
즉 패킷을 보낼 위치를 패킷별로 결정한다. 수신지는 동일한 시스템의 프로세스일 수도, 다른 시스템의 IP 주소일 수도 있다.

라우팅 테이블을 조작하는 데 널리 사용되는 도구인 iptables는 패킷을 가로채고 조작하기 위해 netfilter를 사용한다.

다음과 같이 라우팅 ㅈ어보를 쿼리해서 출력하는 방법을 알아보자.

```shell
sudo route -n
sudo ip route
traceroute ngaysebbkas.info
```

마지막으로 RFC 4271과 기타 IETF 사양에 정의된 경계 게이트웨이 프로토콜 BGP에 대해 간단히 살펴보자.
BGP와 직접 상호 작용할 가능성은 낮지만 BGP의 존재를 인식하고 BGP가 수행하는 작업의 핵심을 이해하는 것은 중요하다.
인터넷은 네트워크들의 네트워크다.
BGP 용어로는 네트워크는 자율 시스템이라고 부르는데, IP 라우팅이 동작하려면 이런 자율 시스템들이 해당  라우팅 데이터와 도달 가능성 데이터를 공유하고 인터넷을 통해 패킷을 전달하는경로를 알려야 한다.

## 전송 계층

이 계층은 전부 엔드포인트 간의 통신 특성에 관한 것이다.
여기에는 연결 지향 프로토콜과 비연결 프로토콜이 있는데, 이들의 신뢰성, QOS, 순차 배송은 꽤 중요한 부분이다.

### 포트

이 계층의 핵심 개념 중 하나는 포트다.
이 계층에서 어떤 프로토콜이 사용되든 그 각각은 포트가 필요하다.
포트란 IP 주소에서 사용 가능한 서비스를 식별하는  고유한 비트 16 숫자다.

단일 (가상) 시스템 내에 여러 서비스가 실행중일 수도 있으며 따라서 시스템의 IP 관점에서는 각 서비스를 식별할 수 있어야 한다.
포트는 다음과 같이 구분이 가능하다.

* 잘 알려진포트
  * SSH 서버나 웹 서버 같은데몬용이다.
  * 이들 중 하나를 사용하려면  높은 권한이 필요하다.
* 등록된 포트
  * 이들은 인터넷 할당 번호 관리기관이 공개적으로 문서화된 프로세스를 통해 관리한다.
* 한시적 포트
  * 등록할 수 없는포트다.
  * 이들은 한시적 포트를 자동으로 할당하는 데 사용되거나 서비스에도 사용될 수 있다.

/etc/services에서 포트와 매핑을 볼 수 있으며, 확실하지 않은 경우 전체 TCP와 UDP 포트 번호 목록을 참조하면 된다.
로컬 시스템에서 사용 중인 항목을 보려면 다음을 확인해보자.

```shell
nmap -A localhost
```

### 전송 제어 프로토콜 (TCP)

TCP는 HTTP와 SSH를 포함한 여러 고수준프로토콜에서 사용되는연결 지향 전송 계층 프로토콜이다.
이는 패킷을 순서대로 전달하는 것을 보장하고 오류 발생 시 재전송을 지원하는 세션 기반의 프로토콜이다.

TCP는 연결 수립부터 종료까지 연결 상태를 추적하며 송신자와 수신자 모두와 전송할 데이터의 양부터 Qos까지 특정 항목들을 협상해야 한다.

보안 관점에서 보면 TCP에는 방어 메커니즘이 없다.
즉 페이로드는 일반 텍스트로 전송되며 발신자와 수신자 사이의 누구나 패킷을 검사할 수 있다.
메시지 암호화를 활성화하려면 TLS 프로토콜을 사용해야 하며, 1.3 버전이 가장 이상적이다.

### 사용자 데이터그램 프로토콜(UDP)

UDP은 통신 설정 없이 데이터그램이라고 부르는 메시지를 보낼 수 있는 비연결형 전송 계층 프로토콜이다.
그럼에도 무결성을 보장하기 위해 데이터그램 체크섬을 지원한다.
NTP, DHCP, DNS 처럼 UD를 사용하는 애플리케이션 수준 프로토콜은 많이 있다.

UDP는 매우 간단한 프로토콜이므로 TCP가 자체적으로 처리하는 많은 일을 해결하려면 그 위에서 동작하는 더 고수준의 프로토콜이 필요하다.
반면에 UDP는 오버헤드가 거이ㅡ 없고 높은 처리량을 달성할 수 있다.

### 소켓

리눅스에서 제공하는 고수준의 통신 인터페이스가 바로 소켓이다.
소켓은 TCP나 UDP 포트와 IP 주소로 구성된 튜플이라는 고유한 ID를 가진 통신의 엔드포인트다.
소켓은 네트워크 관련 도구나 앱을 개발하는 경우에만 사용할 가능성이 높긴하지만, 최소한 쿼리하는 방법은 알아야 한다.

ss 명령을 사용해 소켓 관련 정보를 표시하는 방법을 알아보자. 아래 명령어를 통해 TCP 소켓에 관한 개요를 알아보자.

```shell
ss -s
```

udp는 아래 명령어로 가능하다.

```shell
ss -ulp
```

소켓과 프로세스 관련해 유용하게 사용할 수 있는 도구는 lsof가 있다.

```shell
lsof -c chrome -i udp | head -5
```

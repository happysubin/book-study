## chapter02. 현실에서의 함수형 사고

### 토니 피자 예제

#### 액션과 계산, 데이터

토니는 요리 재료와 기타 필요 자원을 사용하는 코드를 액션으로 구분하고 나머지 코드는 계산으로 구분했습니다.
이번 장에서는 토니의 코드에서 액션과 계산, 데이터 각 분류에 해당하는 예를 살펴보고 코드에 적용한 계층형 설게 원칙이 어떤 것인지 알아본다.

#### 일급 추상

가게 주방에는 많은 로봇이 함께 피자를 만들고 있다. 이것은 분산 시스템이라고 할 수 있다.
토니는 가끔 실패하는 분산 시스템을 이해하려고 타임 다이어그램을 사용했다.
토니는 여러 로봇이 협력할 수 있도록 함수를 인자로 하는 __일급 함수__ 를 사용했다.
그래서 더 많이 더 빨리 피자를 만들 수 있었다.
토니가 어떻게 했는지 알아보자.

### 액션과 계산, 데이터

토니는 먼저 함수형 사고 중에 가장 먼저 액션과 계산, 데이터를 구분하는 것부터 시작했다.

함수형 프로그래머는 코드에서 가장 먼저 이 세가지를 구분하는데 쉽게 다룰 수 있는 부분과 조심히 다뤄야할 부분을 명확하게 하기 위함이다.

토니가 만든 코드도 액션과 계산 데이터로 나눌 수 있다.

#### 1. 액션

액션은 호출 횟수와 시점에 의존한다. 오븐이나 배달차 같은 자원과 요리 재료를 사용하는 것은 액션이다. 액션을 사용할 때 조심해야 한다.

예시로는 반죽 펴기, 피자 배달, 재료 주문이 있다.

#### 2. 계산

어떤 것을 결정하거나 계획하는 것은 계산이다. 계산은 실행해도 다른 곳에 영향을 주지 않는다. 
계산은 아무때나 사용해도 주방이 엉망진창 될 걱정이 없기 때문에 토니는 계산을 좋아한다.

예시로는 조리법에 나온 것을 두 배로 만들기, 쇼핑 목록 결정이 있다.

#### 3. 데이터

토니는 변경 불가능한 데이터를 가능한 한 많이 쓰려고 한다.
결제, 재고, 피자 조리법 같은 것이 데이터다. 데이터는 유연하기 때문에 저장하거나 네트워크로 전송하는 등 다양하게 쓸 수 있다.

예시로는 고객 주문, 영수증, 조리법이 있다.


### 변경 가능성에 따라 코드 나누기

__변경 가능성에 따라 코드를 나눈다.__

위쪽으로 갈수록 자주 바뀌는 코드가 있고 아래쪽으로 갈수록 자주 바뀌지 않는 코드다.

자바스크립트 언어는 잘 바뀌지 않는다. 그래서 가장 아래쪽에는 배열이나 객체 같은 언어 기능을 놓았다.
가운데에는 바뀔 수도 있지만 자주 바뀌지 않는 피자 조리에 대한 내용을 둔다. 가장 위쪽에는 이번 주 메뉴와 같이 자주 바뀌는 사업 아이템을 둔다,


![KakaoTalk_Photo_2024-02-06-20-56-16](https://github.com/happysubin/book-study/assets/76802855/b7d11755-3637-49ba-b9d4-6cefb4bccd6c)

각 계층은 그 아래에 있는 계층을 만들어진다. 그래서 각 계층에 있는 코드는 더 안정적인 기반위에 작성할 수 있다.
이런 구조로 소프트웨어를 만들면 코드를 쉽게 변경할 수 있습니다.
가장 위에 있는 코드는 의존성이 거의 없기 때문에 쉽게 바꿀 수 있다.
아래에 있는 코드들은 위에 있는 코드보다 의존성이 많아 바꾸기 어렵지만 자주 바뀌지 않는다.

함수형 프로그래머는 이 아키텍처 패턴이 계층을 만들기 때문에 __계층형 설계__ 라고 부릅니다.
계층형 설계는 일반적으로 비즈니스 규칙, 도메인 규칙, 기술 스택 계층으로 나눈다.

계층형 설계로 만든 코드는 테스트, 재사용, 유지 보수가 쉽다.

### 일급 추상

다음 타임라인 다이어그램은 로봇 한 대가 피자를 만들기 위한 액션들을 보여준다.

> 주문 접수 -> 반죽 만들기 -> 반죽 펴기 -> 소스 만들기 -> 소스 뿌리기 -> 치즈 뿌리기 -> 치즈 갈기 -> 치즈 뿌리기 -> 오븐에 넣기 -> 10분 기다리기 -> 서빙

타임라인 다이어그램은 사용하면 액션이 시간 순서에 따라 어떻게 실행되는지 볼 수 있다.
액션은 실행 시점에 의존하기 때문에 실행 순서가 중요하다는 것을 잊으면 안된다. 

### 분산 시스템을 타임 라인으로 시각화하기

토니는 피자 만드는 작업을 반죽 만들기, 소스 만들기, 치즈 갈기 작업으로 나누고 로봇 세 대가 동시에 일을 하면 더 빨리 만들 수 있다고 생각했다.

여러 대의 로봇이 함께 일을 하는 것은 분산 시스템을 의미한다.
분산 시스템에서 독립된 액션의 실행 순서는 어떻게 될지 모른다.

> 타임라인이 문제를 파악하는데 도움이 되었지만 실행 순서가 섞이는 것은 어떻게 할 수 없다.

토니는 저녁에 로봇 세 대로 장사를 했지만 완전 실패했다.
많은 피자가 잘못 나왔기 때문이다. 토니가 로봇 세 대가 일하도록 바꾼 타임라인은 엉뚱한 피자가 만들어질 가능성이 있다.

### 각각의 타임라인은 다른 순서로 실행된다.

기본적으로 타임라인은 서로 맞출 수 있는 기능이 없다.

다른 타임 라인이 끝날 때까지 기다리라는 표시가 없어서 순서대로 다음 단계를 그냥 진행한다.

서로 다른 타임라인에 있는 액션 간 실행 순서는 보장할 수 없다.

소스가 먼저 완성되고 반죽이 나중에 완성될 수도 있다. 이 경우 소스를 만드는 로봇은 반죽이 나오기도 전에 반죽을 펴는 작업을 한다.

또는 치즈 가는 작업이 가장 마지막 작업이 될 수 있다. 이경우 소스 만드는 로봇은 치즈 가는 작업이 끝나기도 전에 치즈 뿌리는 작업을 하게 된다.

__즉 타임라인을 서로 맞추지 않은 분산 시스템은 예측 불가능한 순서로 실행된다.__

### 어려운 경험을 통해 분산 시스템에 대해 배운것

1. 기본적으로 타임라인은 서로 순서를 맞추지 않는다.
2. 액션이 실행되는 시간은 중요하지 않다.
3. 드물지만 타이밍이 어긋나는 경우가 실제로 일어난다.
4. 타임라인 다이어그램으로 시스템의 문제를 알 수 있다.

### 타임라인 커팅: 로봇이 서로를 기다릴 수 있게 하기

토니는 타임라인 커팅이라고 부르는 기술을 쓰려고 한다.

타임 라인 커팅은 여러 타임라인이 동시에 진행될 때 서로 순서를 맞추는 방법이다.

타임라인 커팅은 __고차 동작__ 으로 동작한다. (고차 동작이란 고차 함수로 만든 동작)

각 타임라인은 독립적으로 동작하고 작업이 완료되면 다른 타임라인 끝나기를 기다리기 때문에 어떤 타임라인이 먼저 끝나도 괜찮다.

### 좋은 경험을 통해 타임라인에 대해 배운 것

1. 타임라인 커팅으로 서로 다른 작업들을 쉽게 이해할 수 있다.
2. 타임라인 다이어그램을 사용하면 시간에 따라 진행하는 작업을 쉽게 이해할 수 있다.
3. 타임라인 다이어그램은 유연하다.

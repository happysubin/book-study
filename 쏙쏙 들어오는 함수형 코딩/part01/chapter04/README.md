## chapter04. 액션에서 계산 빼내기


### MegarMart.com 장바구니 코드 작성

먼저 장바구니 기능을 수행하는 코드 작성 MegaMartV1.js.

### 새로운 요구사항인 무료 배송비 계산하기 기능 추가

구매 합계가 20달러 이상이면 무료 배송을 해주고자함.

그래서 장바구니에 넣으면 합계가 20달러가 넘는 제품의 구매 버튼 옆에 무료 배송 아이콘을 표시하고자함.

update_shipping_icons 함수가 추가됨.

### 새로운 요구사항인 세금 계산하기가 추가

장바구니의 금액 합계가 바뀔 ㅐ마다 세금을 다시 계산하도록 코드 수정

update_tax_dom 코드를 추가

### 테스트하기 쉽게 만들기

지금 코드는 비즈니스 규칙을 테스트하기 어렵다.

코드가 바뀔 때마다 조지는 아래와 같은 테스트를 만들어야 한다.

1. 브라우저 설정하기
2. 페이지 로드하기
3. 장바구니에 제품 담기 버튼 클릭
4. DOM이 업데이트될 때까지 기다리기
5. DOM에서 값 가져오기
6. 가져온 문자열 값을 숫자로 바꾸기
7. 예상하는 값과 비교하기

현재 코드

```js
function update_tax_dom() {
    set_tax_dom(shopping_cart_total * 0.10)
}
```

결괏값을 얻을 방법은 DOM에서 값을 가져오는 방법이다.

테스트 전에 전역 변수 값을 설정해야하고, 조지가 테스트해야하는 비즈니스 규칙은 total * 0.10이다.



### 테스트 개선을 위한 조지의 제안

1. DOM 업데이트와 비즈니스 규칙은 분리되어야 한다.
2. 전역변수가 없어야 한다.


### 재사용하기 쉽게 만들기

결테김과 배송팀이 우리 코드를 사용하려고 한다.

* 결제팀과 배송팀에서 우리가 만든 코드를 재사용하려고 했지만, 다음과 같은 이유를 재사용할 수 없다.
* 장바구니 정보를 전역변수에서 읽어오고 있지만, 결제팀과 배송팀은 데이터베이스에서 장바구니 정보를 읽어와야 한다.
* 결과를 보여주기 위해 DOM을 직접 바꾸고 있지만, 결제팀은 영수증을, 배송팀은 운송장을 출력해야 한다.

코드를 재사용하려면 아래와 같은 조건이 필요하다.

* 전역변수에 의존하면 안된다.
* DOM을 사용할 수 있는 곳에서 실행된다고 가정하면 안된다.
* 함수가 결괏값을 리턴해야 한다.

### 액션과 계산, 데이터를 구분하기

현재 MegaMartV1.js의 모든 코드는 액션이다. 이제 한번 데이터와 액션, 계산으로 코드를 나눠 리팩토링하자.

### 함수에는 입력과 출력이 있다.

입력은 함수가 계산을 하기위한 외부 정보

출력은 함수 밖으로 나오는 정보나 어떤 동작

__입력과 출력은 명시적이거나 암묵적일 수 있다.__

```js
let total = 0
function add_to_total(amount) {
    console.log(`old total: ${total}`) 
    //전역 변수를 읽는 것은 암묵적 입력,
    //console.log와 같은 출력은 암묵적 출력
    total += amount
    return total
}
```

__함수에 암묵적 입력과 출력이 있으면 액션이 된다.__

암묵적 입력은 함수의 인자로 바꾸고, 암묵적 출력은 함수의 리턴 값으로 바꾸면 된다.

### 테스트 재사용성은 입출력과 관계가 있다.

더 좋은 코드를 위해서는 조지와 제나는 아래와 같은 제안을 했다.

조지
* 제안 1: DOM 업데이트와 비즈니스 규칙은 분리되어야 한다.
* 제안 2: 전역변수가 없어야 한다.

제나 
* 제안 1: 전역변수에 의존하면 안된다.
* 제안 2: DOM을 사용할 . 수있는 곳에서 실행된다고 가정하며 안된다. -> 암묵적 출력은 함수의 리턴으로 바꾸자
* 제안 3: 함수가 결괏값을 리턴해야 한다.

### 액션에서 계산 빼내기

MegaMartV2.js 참고. 

1. 계산 부분을 다른 함수로 추출
2. 전역 변수 사용을 없앰. 리턴 값과 지역변수를 활용 -> 암묵적 입력, 출력을 없앰

따라서 calc_total() 라는 함수는 계싼으로 변했다. 액션에서 계산을 훌륭하게 빼낸 것.


### 액션에서 다른. ㅖ산 빼내기

add_item_to_cart() 함수에서도 계산을 빼냄

add_item() 이라는 새로운 함수가 추가됨. 마찬가지로 전역 변수 배열를 사용안하고 입자와 리턴 값을 추가함.

불변성을 보장하도록 인자를 깊은 복사를 진행해 새로운 인스턴스 리턴.

### 계산 추출을 단계별로 알아보기

1. 계산 코드를 찾아 빼낸다.
2. 새 함수에 암묵적 입력과 출력을 찾는다.
3. 암묵적 입력은 인자로 암묵적 출력은 리턴값으로 바꾼다.

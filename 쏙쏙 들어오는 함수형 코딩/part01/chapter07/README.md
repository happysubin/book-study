## chapter07. 신뢰할 수 없는 코드를 쓰면서 불변성 지키기

### 레거시 코드와 불변성

지금까지 장바구니에 관련된 코드는 모두 카피-온-라이트를 적용해 불변성을 유지했다.

이벤트를 진행하는데 이벤트에서는 많은 곳에서 장바구니 데이터를 변경한다.

잘동작하긴 해도 오래전에 만든 코드라 당장 바꿀 시간이 없다. 그래서 레거시 코드에 쓸 수 있는 안전한 인터페이스가 필요하다.

```js
function add_item_to_cart(name, price) {
    //...코드 생략
    black_friday_promotion(shopping_cart) //이 코드를 추가해야 하지만 이 코드는 장바구니를 바꾼다
}
```

추가된 함수를 호출하면 카피-온-라이트 원칙을 지킬 수 없다.

그리고 black_friday_promotion() 함수를 고칠 수도 없다.

다행히 카피-온-라이트 원칙을 지키면서 안전하게 함수를 사용할 수 있는 다른 원칙이 있다.

이 원칙을 __방어적 복사__ 라고 한다.

### 우리가 만든 카피-온-라이트 코드는 신뢰할 수 없는 코드와 상호작용해야 한다.

블랙 프라이데이 행사 함수는 카피-온-라이트를 적용한 코드가 아니므로 신뢰할 수 없다. 불변성을 지킬 수 없다.

우리가 만든 코드는 불변성이 지켜지는 안전지대에 있따. 안전지대에 있는 코드는 걱정 없이 사용할 수 있다.

블랙 프라이데이 행사 함수는 안전지대 밖에 있지만, 요구 사항을 구현하려면 우리가 만든 코드에서 안전하지 않은 함수를 써야 한다.

따라서 블랙 프라이데이 함수의 입력과 출력을 통해 안전지대에 있는 코드와 데이터를 주고받아야 한다.

안전지대 밖으로 나가는 데이터는 잠재적으로 바뀔 수 있다. 신뢰할 수 없는 코드가 데이터를 바꿀 수 있기 때문이다.

안전지대로 들어오는 데이터 역시도 잠재적으로 바꾸리 수 있다.

우리는 불변성을 지키면서 데이터를 주고 받는 방법을 찾아야 한다.

데이터가 바뀌는 것을 막아주는 원칙이 필요한데, 이 원칙을 __방어적 복사__ 라고 한다.

### 방어적 복사는 원본이 바뀌는 것을 막아 준다.

바뀔 수도 있는 데이터가 신뢰할 수 없는 코드에서 안전지대로 들어온다.

들어온 데이터로 깊은 복사본을 만들고 변경 가능한 원본은 버린다.

신뢰할 수 있는 코드만 복사본을 쓰기 때문에 데이터는 바뀌지 않는다. 이런 방법으로 데이터를 보호한다.

1. 신뢰할 수 없는 코드에 있는 데이터
2. 데이터가 안전지대로 들어온다.
3. 깊은 복사를 만든다.
4. 필요 없다면 변경 가능한 원본은 버린다.
5. 깊은 복사로 만든 복사본은 안전지대에 있다.


안전지대에서 나가는 데이터도 바뀌면 안된다.

안전지대 밖으로 나가는 데이터는 신뢰할 수 없는 코드가 값을 변경할 수 있어서 변경하지 못하도록 해야 한다.

그렇게 하려면 나가는 데이터도 깊은 복사본을 만들어 내보낸다.

1. 안전지대에 있는 데이터를 내보내야함
2. 데이터 깊은 복사를 진행
3. 깊은 복사를 한 데이터를 안전지대에서 내보낸다.

### 방어적 복사 구현하기

Ex1.js를 참고. 데이터를 전달하기 전후에 복사해서 이를 내보내고 받는다.

### 방어적 복사 규칙

1. 데이터가 안전한 코드에서 나갈 때 복사한다.
2. 안전한 코드로 데이터가 들어올 때 복사한다.

### 카피-온-라이트와 방어적 복사를 비교해 봅시다.

카피-온-라이트

* 통제할 수 있는 데이터를 바꿀 때 카피-온-라이트를 사용한다. 불변성을 만들어 안전지대를 만든다.
* 얕은 복사
* 규칙
  * 바꿀 데이터의 얕은 복사를 만든다
  * 복사본을 변경한다
  * 복사본을 리턴한다.

방어적 복사

* 안전지대의 경계와 신뢰할 수 없는 영역에서 데이터가 오고 갈 때 방어적 복사를 쓴다
* 깊은 복사
* 규칙
  * 안전지대로 들어오는 데이터에 깊은 복사를 만든다.
  * 안전지대에서 나가는 데이터에 깊은 복사를 만든다.

### JS에서 깊은 복사는 어렵다

Lodash 라이브러리를 쓰자.
## chapter12. 유령 파일

애플리케이션에서 이미지를 데이터베이스 밖의 파일 시스템에 일반 파일로 저장하는 경우가 많다.

데이터베이스에는 이미지에 대한 경로만 저장하고, 애플리케이션에서 해당 경로의 파일을 연다.

외부 파일 시스템이 고장나면 이미지 관련 서비스에 난리가 날 것이다.

### 목표: 이미지 또는 벌크 미디어 저장

### 안티패턴: 파일을 사용해야 한다고 가정

보통 이미지 파일은 2가지로 저장한다.

1. BLOB 타입을 활용해 저장
2. 파일의 경로를 VARCHAR로 저장

BLOB 방식에는 문제가 존재한다.

#### DELETE 문제

경로를 저장했기 때문에 데이터 로우를 삭제한다고 이미지가 삭제되지 않음.

#### 트랜잭션 문제

데이터베이스 밖에 있는 파일을 변경할 때 원자성 있게 동작하지 않는다. 

#### ROLLBACK 문제

파일을 지우고 롤백을 해도 파일이 살아나지 않는다.

#### 백업 문제

다양한 DBMS에서는 백업 도구를 제공한다.

백업 도구는 테이블에 VARCHAR 칼럼으로 저장된 경로가 가리키는 파일을 어떻게 포함시켜야 하는지 모른다.

따라서 데이터베이스 백업 도구를 사용하고, 그 다음 외부 이미지 파일을 백업하기 위해 파일 시스템 백업 도구를 활용해야 한다.

이마저도 잘 동작하리라고 확신하기 어렵다. 너무 복잡.

#### SQL 접근 권한 문제

외부 파일은 GRANT나 REVOKE 같은 SQL 문으로 할당한 접근권한을 우회한다.
SQL 접근권한 제어를 통해 테이블과 칼럼에 대한 접근을 통제할 수 있지만, 데이터베이스에서 문자열로 경로만 가지고 있는 외부 파일에 대해서는 적용되지 않는다.

#### SQL 데이터 타입 문제

문자열이 유효한 경로인지 검증하지 않고, 해당 경로가 실제로 존재하는지도 검증할 수 없다.

이 문자열을 다루는 로직은 어떤 것이든 애플리케이션 코드에 의존할 수 밖에 없다. -> 애플리케이션 코드에 의존하는 것도 장점이 있다고 생각

### 안티 패턴 인식 방법

* 데이터 백업과 복원 절차는 어떻게 되는가? 백업을 어떻게 검증할 수 있는가? 백업을 만든 서버 이외의 다른 서버에서 데이터 복원 테스트를 해본 적이 있는가?
* 이미지가 계속 쌓이는가? 아니면 더 이상 필요하지 않으면 시스템에서 삭제되는가? 이미지를 삭제하는 절차는 어떻게 되는가? 자동화된 절차인가? 수작업 절차인가?
* 애플리케이션의 어떤 사용자가 이미지를 볼 수 있는 권한이 있는가? 권한은 어떻게 확인하는가? 권한이 없는 이미지를 요청하면 사용자가 뭘 보게 되는가?
* 이미지에 대한 변경을 취소할 수 있는가? 그렇다면, 애플맄이션이 이전 상태의 이미지로 복원해야하는가

### 안티 패턴 사용이 합당한 경우

* 이미지가 없으면 DB가 가벼워진다.
* 이미지를 제외하면 데이터베이스 백업이 빨라지고 결과도 작다.
* 이미지가 데이터베이스 외부의 파일로 되어 있으면, 일반적인 이미지 미리보기나 편집이 쉽다.

### 해법: 필요한 경우에는 BLOB 타입을 사용
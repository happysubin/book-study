## chapter04. 아이디가 필요해


### PK 관례 확립

PK는 좋은 데이터베이스 설계에 정말 중요하다.

PK는 테이블 내의 모든 행이 유일함을 보장하기 때문에, 각 행에 접근하는 논리적 메커니즘이 되고 중복 행이 저장되는 것을 방지한다.

또한 PK는 관계를 생성할 때 FK로부터 참조되기도 한다.

까다로운 부분은 PK로 사용할 컬럼을 선정하는 일이다. 대부분의 테이블에서 어느 속성의 값이든 하나 이상의 행에서 나타날 잠재적 가능성이 있다.
이름, 이메일 주소, 미국의 사회보장번호, 납세자 ID와 같은 관리적 식별번호조차도 엄밀히 말하면 유일하지 않다.

이런 테이블에는 테이블로 모델링한 영역에서는 아무런 의미도 가지지 않는 인위적인 값을 저장할 새로운 칼럼이 필요하다.

이 칼럼을 PK로 사용하면, 다른 속성 칼럼에는 중복 값이 들어가는 것을 허용ㅎ는 반면 특정 행에 유일하게 접근할 수 있게 된다.

이런 형태의 PK를 가상키 또는 대체키라 한다.

> 대부분의 DBMS는 트랜잭션 격리 범위 밖에서 유일한 정수 값을 생성하는 메커니즘을 제공한다.
> AUTO_INCREMENT, GENERATOR, SEQUENCE, SERIAL 등

### 안티패턴: 만능키

책이나 기사, 프로그래밍 프레임워크는 데이터베이스 내 모든 테이블이 다음 과 같은 특성을 가지는 PK 칼럼을 가지도록 하는 문화적 관례를 만들었다.

* pk 칼럼 이름은 id다.
* pk 칼럼의 데이터 타입은 32비트 또는 64비트 정수다.
* 유일한 값은 자동 생성된다.

모든 테이블에 id란 이름의 칼럼이 있는 것은 너무도 흔해져 이게 PK와 동의어가 되어버렸다.

모든 테이블에 id 칼럼을 추가하는 것은, 그 사용을 이상하게 만드는 몇 가지 효과를 초래한다.

#### 중복 키 생성

* 습관적을 id 칼럼을 정의한다.
* 그리고 다른 컬럼에도 unique가 정의되어 있는 경우
* 그럼 id와 unique 키는 서로를 식별할 수 있도록 해준다는 면에서 비슷하다.

#### 중복 행 허용

* 복합키는 여러 칼럼을 포함한다.
* 복합키가 사용되는 전형적인 예는 교차(중간) 테이블 안에서다.
* PK는 특정한 pk 2개ㅇ 값의 조합이 테이블 안에서 한 번만 나타난다는 것을 보장해야 한다.
* 각 값이 다른 쌍으로 여러 번 나타날 수 있을지라도 말이다.
* 그러나 습관적으로 생성한 id 컬럼을 사용하는 경우에는 유일해야 하는 두 칼럼에 제약 조건이 적용되지 않는다.
* 중복을 방지하기 위해서는 다른 두 컬럼에 unique 제약 조건을 걸어야하는데, 이러면 id 칼럼은 불필요하다.

#### 모호한 키의 의미

* id란 이름은 너무 일반적이므로 아무런 의미도 가지지 못한다.
* id가 다양한 테이블에서 공통적으로 쓰인다면 모호하므로 프로그램 언어에서 활용하기도 까다롭다.
* bug_id, account_id 처럼 명확하게 정해주는 것이 좋다.

#### USING 사용

* 모든 테이블이 id란 이름의 가상키를 pk로 정의했다면, 종속된 테이블에서의 FK 칼럼 이름은, 참조하는 FK 칼럼의 이름과 같을 수 없게 된다.
* 따라서 항상 약간은 장황한 ON 문접을 사용해야 한다.

#### 어려운 복합키

* 복합키가 어렵다고 거부하는 사람도 많은데 이러면 안된다.

### 안티패턴 인식 방법

* 이 테이블에는 PK가 없어도 될 것 같은데 -> 가상키와 PK를 혼동, 보통 자연키나 복합키 사용이 필요
* 다대다 연결에서 왜 중복이 발생했지? -> 제약 조건을 걸라는데.. 애플리케이션 검증이 잘못 됐다고 생각
* 정규화에 대한 오해. 정규화는 가상키와 아무런 상관이 없다.

### 안티패턴 사용이 합당한 경우 

* 객체-관계 프레임워크에서는 CoC(Convention over Configuration)를 통해 개발을 단순화한다.
* 이런 프레임워크에서는 모든 테이블이 동일한 방식으로 pk를 정의한다고 가정한다,.
* 이런 프레임 워크를 사용한다면 그 관례를 따르고 싶을 것이다.
* 그렇게 해야 프레임워크의 다른 원하는 기능을 사용할 수 없기 때문이다.

물론 가상키 사용과, 자동 증가하는 정수를 사용해 키 값을 할당하는 것이 잘못은 아니다.

그러나 모든 테이블에 가상키가 필요한 것도 아니고, 모든 가상키 칼럼 이름을 id로 해야 하는 것도 아니다.

가상키는 지나치게 긴 자연키를 대체하기 위해 사용한다면 적절한 선택이다. 인덱스 저장 공간이 너무 커질 수도 있으므로

### 해법: 상황에 맞추기

#### 있는 그대로 말하기

pk에 의미 있는 이름을 선택하자. id가 아닌 bug_id. FK에서도 동일하게 적용하자.

#### 관례에서 벗어나기

객체-관계 프레임워크는 id란 이름의 가상키가 사용될 것을 기대하지만, 다른 이름을 사용하도록 재설정하는 것도 허용한다.

#### 자연키와 복합키 포용

처음에는 자연키로 손색이 없어 보이던 칼럼이 나중에 알고 보니 적법하게 중복을 허용하는 것으로 밝혀질 수도 있다.
이런 경우에는 가상키를 활용하자.

복합키가 적절한 경우에는 이를 사용하자. 교차 테이블에서와 같이 여러 컬럼의 조합으로 행을 갖아 잘 식별할 수 있다면, 이 칼럼 조합을 복합키로 사용해야 한다.


### 개인 생각 정리

* 제약 조건은 안 걸고 애플리케이션에서 검증하자. 성능과 확장에서 유리
* id 말고 의미있게 이름을 적자. 대신 가상키, 자동 증가 정수가 나쁘지 않다. 언제 요구사항이 바뀔지 모르기 때문..
* 교차 테이블에서 복합키를 pk로 사용하는 것은 좋다고 생각.
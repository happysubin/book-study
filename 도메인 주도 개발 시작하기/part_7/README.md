# part 7. 도메인 서비스

## chapter 7.1 여러 애그리거트가 필요한 기능

* 도메인 영역의 코드를 작성하다 보면, 한 애그리거트로 기능을 구현할 수 없을 때가 있다. 대표적인 예가 결제 금액 계산 로직.
* 상품 애그리거트(가격), 주문 애그리거트(개수), 할인 쿠폰 애그리거트(쿠폰 할인), 회원 애그리거트(등급 할인) 등 다양한 애그리거트가 필요하다.
* 그럼 누가 실제 결제 금액을 계산해야하는 주체일까? 총 주문 금액을 계산하는 것은 주문 애그리거트가 할 수 있지만 실제 결제 금액은 이야기가 다르다.
* 생각해 볼 수 있는 방법은 주문 애그리거트가 필요한 모두 가지도록 한 뒤 할인 금액 계싼 책임을 주문 애그리거트에 할당하는 것이다.
* 과연 결제 금액 계산 로직이 주문 애그리거트의 책임이 맞을까?
* 할인 정책이 추가되면 주문 애그리거트는 갖고 있는 구성요소와 관련이 없음에도 불구하고 결제 금액 계산 책임이 주문 애그리거트에 있다는 이유로 주문 애그리거트의 코드를 수정해야 한다.
* 이렇게 한 애그리거트에 넣기 애매한 도메인 기능을 억지로 특정 애그리거트에 구현하면 안 된다.
* 억지로 구현하면 애그리거트는 자신의 책임 범위를 넘어서는 기능을 구현하기 때문에 코드가 길어지고 외부에 대한 의존이 높아지게 되며 코드를 복잡하게 만들어 수정을 어렵게 만드는 요인이 된다.
* 게다가 애그리거트의 범위를 넘어서는 도메인 개념이 애그리거트에 숨어들어 명시적으로 드러나지 않게 된다.
* 이런 문제를 해소하는 가장 쉬운 방법이 하나 있는데, 바로 도메인 기능을 별도 서비스로 구현하는 것이다.


## chapter 7.2 도메인 서비스

### section 7.2.1 계산 로직과 도메인 서비스

* 도메인 서비스는 도메인 영역에 위치한 도메인 로직을 표현할 때 사용한다. 주로 아래와 같은 상황에서 사용한다.
* 계산 로직: 여러 애그리거트가 필요한 계산 로직이나, 한 애그리거트에 넣기에는 다소 복잡한 계산 로직
* 외부 시스템 연동이 필요한 로직: 구현하기 위해 타 시스템을 사용해야하는 도메인 로직
* 응용 영역의 서비스가 응용 로직을 다룬다면 도메인 서비스는 도메인 로직을 다룬다.
* 도메인 영역의 애그리거트나 밸류와 같은 구성요소와 도메인 서비스를 비교할 때 다른 점은 도메인 서비스는 상태 없이 로직만 구현한다는 점이다.
* 도메인 서비스를 구현하는데 필요한 다른 상태는 다른 방법으로 전달받는다. 매개변수 이런 방법으로.
* 도메인 서비스를 사용하는 주체는 애그리거트가 될 수도 있고 응용 서비스가 될 수도 있다.
* 애그리거트에 도메인 서비스를 주입해서 애그리거트가 사용하도록하자. 응용 서비스가 애그리거트 객체에 도메인 서비스를 전달하는 책임을 가진다.
* 반대로 애그리거트 메서드를 실행할 대 도메인 서비스를 인자로 전달하지 않고, 도메인 기능을 실행할 때 애그리거트를 전달하기도 한다.
  * 이 경우는 2개의 애그리거트를 관리하는 계좌 이체의 경우가 예시로 나왔더ㅏ.
* 참고 - 도메인 서비스 객체를 애그리거트에 주입하지말자!

### section 7.2.2 외부 시스템 연동과 도메인 서비스

* 외부 시스템이나 타 도메인과의 연동 기능도 도메인 서비스가 될 수 있다.
* 예를 들어 설문 조사 시스템과 사용자 역할 관리 시스템이 분리되어 있다.
* 설문 조사 시스템은 설문 조사를 생서할 때 사용자가 생성 권한을 가진 역할인지 확인하기 위해 역할 관리 시스템과 연동해야 한다.
* 시스템 간 연동은 API로 이루어질 수 있지만 설문 조사 도메인 입장에서는 사용자가 설문 조사 생성 권한을 가졌는지 확인하는 도메인 로직으로 볼 수 있다.
* 이 도메인 로직은 도메인 서비스로 표현할 수 있다. 인터페이스(도메인 패키지)를 작성하고 구체 클래스(인프라스트럭쳐 패키지)로 구현하는 것이 바람직함.

### section 7.2.3 도메인 서비스의 패키지 위치

* 도메인 서비스는 도메인 로직을 표현하므로 도메인 서비스의 위치는 다른 도메인 구성요소와 동일한 패키지에 위치한다.
* 예를 들어 주문 금액 계산을 위한 도메인 서비스는 주문 애그리거트와 같은 패키지에 위치한다.
* 도메인 서비스의 개수가 많거나 엔티티나 밸류와 같은 다른 구성요소와 명시적으로 구분하고 싶다면 domain.model, domain.service, domain.repository와 같이 하위 패키지를 구분하여 위치시켜도 된다.

### section 7.2.4 도메인 서비스의 인터페이스와 클래스

* 도메인 서비스의 로직이 고정되어 있지 않은 경우 도메인 서비스 자체를 인터페이스로 구현하고 이를 구현한 클래스를 둘 수도 있다.
* 특히 도메인 로직을 외부 시스템이나 별도 엔진을 이용해서 구현할 때 인터페이스와 구체 클래스를 분리한다.
* 도메인 영역에는 도메인 서비스가 위치하고, 실제 구현은 인프라스트럭처 영역에 위치한다. 의존성 역전!
* 도메인 서비스의 구현이 특정 구현 기술에 의존하거나 외부 시스템의 API를 실행한다면 도메인 영역의 도메인 서비스는 인터페이스로 추상화해야 한다.
* 이를 통해 도메인 영역이 특정 구현에 종속되는 것을 방지할 수 있고 도메인 영역에 대한 테스트가 쉬워진다.

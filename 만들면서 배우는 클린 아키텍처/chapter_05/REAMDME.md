# chapter 5. 웹 어댑터 구현하기

우리가 목표로 하는 아키텍처에서 외부 세계와의 모든 커뮤니케이션은 어댑터를 통해 이뤄진다.
웹 인터페이스를 제공하는 어댑터의 구현 방법을 살펴보자.

## 의존성 역전

* 웹 어댑터는 '주도하는' 혹은 '인커밍' 어댑터다.
* 외부로부터 요청을 받아 애플맄이션 코어를 호출하고 무슨 일을 해야 할지 알려준다.
* 이때 제어 흐름은 웹 어댑터에 있는 컨트롤러에서 애플리케이션 계층에 있는 서비스로 흐른다.
* 애플리케이션은 웹 어댑터가 통신할 수 있는 특정 포트를 제공한다.
* 서비스는 이 포트를 구현하고, 웹 어댑터는 이 포트를 호출할 수 있다.

그럼 왜 어댑터와 유스케이스 사이에 또 다른 간접 계층을 넣어야 할까?

* 애플리케이션 코어가 외부 세계와 통신할 수 있는 곳에 대한 명세가 포트이기 때문이다.
* 포트를 적절한 곳에 위치시키면 외부와 어떤 통신이 일어나고 있는지 정확히 알 수 있고, 이는 레거시 코드를 다루는 유지보수 엔지니어에게는 무척 소중 한 정보다.

웹 애플리케이션이 웹 어댑터에 능동적으로 알림을 줘야 한다면(웹소켓) 의존성을 올바른 방향으로 유지하기 위해 아웃 고잉 포트를 통과해야 한다.
그러면 웹 어댑터는 인커밍 어댑터인 동시에 아웃고잉 어댑터가 된다. 하지만 한 어댑터가 동시에 두 가지 역할을 하지 못할 이유는 없다.
이번에는 인커밍 어댑터 역할만 가정하고 실습을 진행함.

## 웹 어댑터의 책임

웹 어댑터는 일반적으로 다음과 같은 일을 한다.

* HTTP 요청을 자바 객체로 매핑
* 권한 검사
* 입력 유효성 검증
* 입력을 유스케이스의 입력 모델로 매핑
* 유스케이스 호출
* 유스케이스의 출력을 HTTP로 매핑
* HTTP 응답을 반환

앞 단원에서는 유효성 검증이 유스케이스 입력 모델의 책임이라고 이야기하지 않았는가?

* 유스케이스 입력 모델은 유스케이스의 맥락에서 유효한 입력만 허용해야 한다.
* 그러나 여기서는 웹 어댑터의 입력 모델에 대해 이야기하고 있다.
* 유스케이스의 입력 모델과는 구조나 의미가 완전히 다를 수 있으므로 또 다른 유효성 검증을 수행해야 한다.
* 유스케이스 입력 모델에서 했던 유효성 검증을 똑같이 웹 어댑터에서도 구현해야 하는 것은 아니다.
* 웹 어댑터의 입력 모델을 유스케이스의 입력 모델로 변환할 수 있다는 것을 검증해야 한다.
* 이 변환을 방해하는 모든 것이 유효성 검증 에러다.
* 이는 자연스럽게 웹 어댑터의 다음 책임, 즉 변환된 입력 모델로 특정한 유스케이스를 호출하는 것으로 연결된다.
* 어댑터는 유스케이스의 출력을 반환하고, HTTP 응답으로 직렬화해서 호출자에게 전달한다.

웹 어댑터의 책임이 많지만, 이 책임들은 애플리케이션 계층에 침투하면 절대 안된다.

## 컨트롤러 나누기

컨트롤러는 얼마나 만들어야 할까? 적은 것보다는 많은게 낫다.

* 각 컨트롤러가 가능한 한 좁고 다른컨트롤러와 가능한 한 적게 공유하는 웹 어댑터 조각을 구현해야 한다.
* 계좌 리소스와 관련된 모든 것이 하나의 클래스에 모여 있는 예제를 살펴봄.
* 이 방식의 단점을 살펴보았다.
 

1. 클래스마다 코드는 적을수록 좋다. 
2. 클래스에 코드가 많아지면 테스트 코드도 많아진다. 테스트 코드는 프로덕션 코드보다 더 추상적이라 파악하기 어려울 때가 많다. 
3. 제일 중요한점은 모든 연산을 단일 컨트롤러에 넣는 것이 데이터 구조의 재활용을 촉진한다. 쉽게 말하면 DTO를 재활용한다고 이해.

그래서 글쓴이는 각 연산에 대해 가급적이면 별도의 패키지 안에 별도의 컨트롤러를 만드는 방식을 선호한다고 한다.
또한 가급적 메서드와 클래스명은 유스케이스를 최대한 반영해서 지킨다고 한다.
이 방식을 사용하면 두 명의 개발자가 서로 다른 연산에 대해 코드를 짜고 있으면 병합 충돌이 일어나지 않는다.

이건 꿀팁인 거 같은데 register이란 단어가 create보다 낫다고 한다.

## 정리

* 컨트롤러는 최대한 세분화해서 만들자.
* 웹 어댑터를 구현할 때는 HTTP 요청을 애플리케이션의 유스케이스에 대한 메서드 호출로 변환하고 결과를 다시 HTTP로 변환하고 어떤 도메인 로직도 수행하지 않는 어댑터를 마들고 있다는 점을 염두에 둬야 한다.
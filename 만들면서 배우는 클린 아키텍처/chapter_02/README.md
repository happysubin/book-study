# chapter 2. 의존성 역전하기

## 단일 책임 원칙 (SRP)

* 하나의 컴포넌트는 오로지 한 가지 일만 해야 하고, 그것을 올바르게 수행해야 한다.
* __컴포넌트를 변경하는 이유는 오직 하나뿐이어야 한다.__
* 아키텍처에서의 의미는 컴포넌트를 변경할 이유가 한 가지라면 우리가 어떤 다른 이유로 소프트웨어를 변경하더라도 이 컴포넌트에 대해서는 전혀 신경쓸 필요가 없다.
* 소포트웨어가 변경되더라도 여전히 우리가 기대한 대로 동작할 것이기 때문이다.
* A가 B와 C에 의존한다고 하면 A는 B가 변경될 때 수정되어야 하고, C가 수정될 때도 수정되어야 한다. 이는 SRP를 지키지 못한 것이다.

## 의존성 역전 원칙

* 코드상의 어떤 의존성이든 그 방향을 바꿀 수(역전시킬 수) 있다.
* 도메인 계층에 리포지토리에 대한 인터페이스를 만들고, 실제 리포지토리는 영속성 계층에서 구현한다.
* 도메인 계층에 인터페이스를 도입함으로써 의존성을 역전시킨다. 그 덕분에 영속성 계층이 도메인 계층에 의존하게 되었다.

## 클린 아키텍처

* 클린 아키텍처란 도메인 코드가 바깥으로 향하는 어떤 의존성도 없어야 함을 의미한다.
* 대신 의존성 역전 원칙의 도움으로 모든 의존성이 도메인 코드를 향하고 있다.
* 이 아키텍처에서 계층들은 동심원으로 둘러싸여 있다.
* 해당 아키텍처에서 가장 주요한 규칙은 의존성 규칙으로, 계층 간의 모든 의존성이 안쪽으로 향해야 한다는 것이다.
* 이 아키텍처의 코어에는 주변 유스케이스에서 접근하는 도메인 엔티티들이 있다.
* 유스케이스는 앞에서 서비스라고 불렸던 것들인데, 단일 책임을 갖기 위해 조금 더 세분화돼 있다.
* 이를 통해 이전에 이야기한 넓은 서비스 문제를 해결할 수 있다.

이 코어 주변으로 비즈니스 규칙을 지원하는 애플리케이션의 다른 모든 컴포넌트들을 확인할 수 있다.
여기서 지원은 영속성을 제공하거나 UI를 제공하는 것 등을 의미한다. 또한 바깥쪽 계층들은 다른 서드파티 컴포넌트에 어댑터를 제공할 수 있다.
또한 바깥쪽 계층들은 다른 서드파티 컴포넌트에 어댑터를 제공할 수 있다.

* 도메인 코드에서는 어떤 영속성 프레임워크나 UI 프레임워크가 사용되는지 알 수 없고 특정 프레임워크에 특ㄹ정화된 코드를 가질 수 없고 비즈니스 규칙에 집중할 수 있다.
* 그래서 도메인 코드를 자유롭게 모델링할 수 있다.

클린 아키텍처에는 대가가 따른다.

* 도메인 계층이 영속성이나 UI 같은 외부 계층과 철저하게 분리돼야 하므로 애플리케이션의 엔티티에 대한 모델을 각 계층에서 유지보수해야 한다.
* 일반적으로 ORM은 데이터베이스 구조 및 객체 필드와 데이터베이스 칼럼의 매핑을 서술한 메타데이터를 담고 있는 엔티티 클래스를 필요로 한다.
* 도메인 계층은 영속성 계층을 모르기 때문에 도메인 계층에서 사용한 엔티티 클래스를 영속성 계층에서 함께 사용할 수 없고 두 계층에서 각각 엔티티를 만들어야 한다.
* 즉, 도메인 계층과 영속성 계층이 데이터를 주고 받을 때, 두 엔티티를 서로 변환해야 한다는 뜻이다. 도메인 계층과 다른 계층 사이에서도 마찬가지다.
* 이는 바람직한 일이다. 이것이 프레임워크와 도메인을 분리한 상태다.
* 우리가 흔히 JPA를 사용하면서 @Entity 애노테이션을 사용해 엔티티 및 도메인을 정의한 것은 프레임워크와 도메인이 결합된 상태라고 한다. 역시 설계는 트레이드 오프다.

## 육각형 아키텍처

* 육각형 안에는 도메인 엔티티와 이와 상호작용하는 유스케이스가 있다.
* 육각형에서 외부로 향하는 의존성이 없기 때문에 클린 아키텍처에서 제시한 의존성 규칙이 그대로 적용된다.
* 육각형 바깥에는 애플리케이션과 상호작용하는 다양한 어댑터가 있다.(웹 어댑터, 외부 시스템 어댑터 등)
* 애플리케이션 코어와 어댑터들 간의 통신이 가능하려면 애플리케이션 코어가 각각의 포트를 제공해야 한다.
* 주도하는 어댑터에게는 그러한 포트가 코어에 있는 유스케이스 클래스들에 의해 구현되고 호출되는 인터페이스가 된다.
* 주도되는 어댑터에게는 그러한 포트가 어댑터에 의해 구현되고 코어에 의해 호출되는 인터페이스가 될 것이다.

이러한 핵심 개념으로 인해 이 아키텍처 스타일은 포트와 어댑터의 아키텍처라고도 알려져 있다.

## 유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?

의존성을 역전시켜 도메인 코드가 다른 바깥쪽 코드에 의존하지 않게 함으로써 영속성과 UI에 특화된 문제로부터 도메인 로직의 결합을 제거하고 코드를 변경할 이유의 수를 줄일 수 있다.
변경할 이유가 적을수록 유지보수성은 더 좋아진다.